---
title: "Linear models and other wranglings"
author: "Stephanie J. Spielman"
date: "spielman@rowan.edu"
output: 
  html_document:
    highlight: zenburn
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Description

This RMarkdown document displays results from several linear models performed for associated manuscript. All significant comparisons are highlighted. In addition, the document shows interactive data wrangling performed and present in the manuscript.

```{r load-libs-data, warning=FALSE, message=FALSE}
source("load.R") ## loads in all libraries, data and formats for use
library(knitr)
library(kableExtra)
library(multcomp)
library(lme4)
library(lmerTest)
SIG.ALPHA <- 0.01 ## significance threshold

style_kable_sig <- function(df)
{
  df %>%
    mutate(n = 1:n()) %>%
    filter(sig == TRUE) %>%
    pull(n) -> highlight_rows
  
  df %>%
    knitr::kable(format = "html") %>%
    kable_styling("striped", "hover") %>%
    row_spec(highlight_rows, color = "black", background = "lemonchiffon")
}
```


## Linear models

### Model 1: Does the model fit systematically affect distance from true tree? 

We perform a random effects model with:

+ normalized robinson-foulds distance as the response
+ model as a fixed effect
+ simulation parameterization and tree each as random effects

##### MutSel simulations
```{r model-1, warning=FALSE, message=FALSE}
lmer(rf_true_norm ~ model_levels + (1|name_levels) + (1|tree_levels), data = simulation_rf_fit) -> fit
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```

##### Control simulations
```{r model-1-control, warning=FALSE, message=FALSE}
lmer(rf_true_norm ~ model_levels + (1|name_levels) + (1|tree_levels), data = control_rf_fit) -> fit
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```


### Model 2: Does the model fit systematically affect false positive rates (assessed using UFBoot2 with a 95% threshold)? 

We perform a random effects model with:

+ false positive rate as the response
+ model as a fixed effect
+ simulation parameterization and tree each as random effects

##### MutSel simulations
```{r model-2, warning=FALSE, message=FALSE}
fit <- lmer(FPR ~ model_levels + (1|tree_levels) + (1|name_levels), data = ufb_fact_classif)
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```


##### Control simulations
```{r model-2-control, warning=FALSE, message=FALSE}
######## RF for simulations
fit <- lmer(FPR ~ model_levels + (1|tree_levels) + (1|name_levels), data = control_ufb_fact_classif)
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```


### Model 3: Does the model fit systematically affect accuracy (assessed using UFBoot2 with a 95% threshold)? 

We perform a random effects model with:

+ false positive rate as the response
+ model as a fixed effect
+ simulation parameterization and tree each as random effects

##### MutSel simulations
```{r model-3, warning=FALSE, message=FALSE}
fit <- lmer(accuracy ~ model_levels + (1|tree_levels) + (1|name_levels), data = ufb_fact_classif)
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```

##### Control simulations
```{r model-control, warning=FALSE, message=FALSE}
######## RF for simulations
fit <- lmer(accuracy ~ model_levels + (1|tree_levels) + (1|name_levels), data = control_ufb_fact_classif)
glht(fit, linfct=mcp(model_levels='Tukey')) %>% 
  summary() %>% 
  broom::tidy() %>%
  mutate(sig = p.value <= SIG.ALPHA) %>%
  arrange(sig, lhs, estimate) %>%
  style_kable_sig()
```
## Data wrangling

put the au stuff here
and the rf=0 stuff here


<!--
###################################################################################################
########################### MISCELLANEOUS EYEBALLING OF SOME DATA #################################
###################################################################################################
control_rf_fit %>% 
  filter(rf_true_norm == 0, model_levels == "m1") %>% select(ic.rank) %>% print.data.frame()


control_rf_fit %>% 
 filter(rf_true_norm == 0) %>%
 count(name_levels, tree_levels, model_levels) %>%
 print.data.frame()
# name_levels  tree_levels model_levels  n


### which specific simulations had RF=0?
# simulation_rf_fit %>% 
#   filter(rf_true_norm == 0) %>%
#   count(name_levels, tree_levels, model_levels) %>%
#   print.data.frame()

### which trees overall showed SIGNIFICANT AU tests?
# simulation_topology %>%
#   filter(whichtest == "au") %>%
#   pivot_longer(m1:true, names_to="model", values_to = "pvalue") %>%
#   filter(pvalue <= SIG.ALPHA) %>%
#   count(model)


### which specific simulations showed SIGNIFICANT AU tests?
# simulation_topology %>%
#   filter(whichtest == "au") %>%
#   pivot_longer(m1:true, names_to="model", values_to = "pvalue") %>%
#   filter(pvalue <= SIG.ALPHA) %>%
#   count(model, name, tree) %>% 
#   arrange(model, name, tree) %>%


-->